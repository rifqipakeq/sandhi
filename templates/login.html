{% extends "base.html" %}
{% block title %}Login{% endblock %}
{% block content %}
<div class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md p-8 space-y-6 rounded-2xl shadow-xl bg-white/10 backdrop-blur-md border border-white/20">
        
        <h1 class="text-4xl font-bold text-white text-center">Sandhi</h1>
        <h2 class="text-2xl font-semibold text-center text-gray-200">Login</h2>

        <div class="flex border-b border-white/20">
            <button id="tab-password" class="flex-1 py-2 text-sm font-medium text-white border-b-2 border-purple-500">Password</button>
            <button id="tab-face" class="flex-1 py-2 text-sm font-medium text-gray-400">Wajah</button>
        </div>

        <div id="panel-password">
            <form class="space-y-6" action="{{ url_for('auth.login') }}" method="POST">
                <div>
                    <label for="username_pass" class="text-sm font-medium text-gray-300">Username</label>
                    <input id="username_pass" name="username" type="text" required
                           class="w-full px-4 py-2 mt-2 text-gray-200 bg-white/5 border border-white/20 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 focus:bg-white/10">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-300">Password</label>
                    <input id="password" name="password" type="password" required
                           class="w-full px-4 py-2 mt-2 text-gray-200 bg-white/5 border border-white/20 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 focus:bg-white/10">
                </div>
                <button type="submit"
                        class="w-full px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-purple-600 rounded-md shadow-sm hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200">
                    Login
                </button>
            </form>
        </div>

        <div id="panel-face" class="hidden">
            <div class="space-y-4">
                <div>
                    <label for="username_face" class="text-sm font-medium text-gray-300">Username</label>
                    <input id="username_face" name="username_face" type="text" required
                           class="w-full px-4 py-2 mt-2 text-gray-200 bg-white/5 border border-white/20 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 focus:bg-white/10"
                           placeholder="Masukkan username Anda dulu">
                </div>
                
                <div class="p-4 border border-white/20 rounded-lg">
                    <div class="relative w-full max-w-xs mx-auto bg-gray-900 rounded-md overflow-hidden aspect-video">
                        <video id="video-feed-login" autoplay muted playsinline class="w-full h-full"></video>
                        <canvas id="overlay-canvas-login" class="absolute top-0 left-0 w-full h-full"></canvas>
                    </div>
                    
                    <button type="button" id="start-camera-btn-login" class="w-full mt-2 px-4 py-2 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700">Mulai Kamera</button>
                    
                    <button type="button" id="login-face-btn" class="w-full mt-2 px-4 py-2 text-sm text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>Login dengan Wajah</button>
                    <p id="feedback-text-login" class="text-center text-yellow-400 text-sm h-4 mt-2"></p>
                </div>
            </div>
        </div>
        
        <p class="text-sm text-center text-gray-400">
            Belum punya akun? <a href="{{ url_for('auth.register') }}" class="font-medium text-purple-400 hover:text-purple-300">Register</a>
        </p>
    </div>
</div>

<script src="{{ url_for('static', filename='js/face-api.min.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabPassword = document.getElementById('tab-password');
        const tabFace = document.getElementById('tab-face');
        const panelPassword = document.getElementById('panel-password');
        const panelFace = document.getElementById('panel-face');

        tabPassword.addEventListener('click', () => {
            panelPassword.classList.remove('hidden');
            panelFace.classList.add('hidden');
            tabPassword.classList.add('text-white', 'border-purple-500');
            tabFace.classList.remove('text-white', 'border-purple-500');
            tabFace.classList.add('text-gray-400');
            stopFaceApi();
        });

        tabFace.addEventListener('click', () => {
            panelPassword.classList.add('hidden');
            panelFace.classList.remove('hidden');
            tabFace.classList.add('text-white', 'border-purple-500');
            tabPassword.classList.remove('text-white', 'border-purple-500');
            tabPassword.classList.add('text-gray-400');
        });

        const video = document.getElementById('video-feed-login');
        const canvas = document.getElementById('overlay-canvas-login');
        const startCameraBtn = document.getElementById('start-camera-btn-login');
        const loginFaceBtn = document.getElementById('login-face-btn');
        const feedbackText = document.getElementById('feedback-text-login');
        const usernameInput = document.getElementById('username_face');

        const MODEL_URL = '/static/models';
        let modelsLoaded = false;
        let stream = null;

        async function loadModels() {
            if (modelsLoaded) return;
            feedbackText.textContent = 'Mempersiapkan...';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
            modelsLoaded = true;
            feedbackText.textContent = 'Model siap.';
            loginFaceBtn.disabled = false;
        }

        async function startCamera() {
            if (stream) return; 
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                startCameraBtn.disabled = true;
                startCameraBtn.textContent = 'Kamera Aktif';
                loadModels(); 
            } catch (err) {
                console.error("Error starting camera:", err);
                feedbackText.textContent = 'Gagal mengakses kamera.';
            }
        }
        
        function stopFaceApi() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                startCameraBtn.disabled = false;
                startCameraBtn.textContent = 'Mulai Kamera';
                loginFaceBtn.disabled = true;
                modelsLoaded = false;
            }
        }

        async function handleFaceLogin() {
            const username = usernameInput.value;
            if (!username) {
                feedbackText.textContent = 'Silakan masukkan username Anda.';
                return;
            }
            if (!modelsLoaded) {
                feedbackText.textContent = 'Model belum siap. Tunggu sebentar.';
                return;
            }

            feedbackText.textContent = 'Mendeteksi wajah...';
            loginFaceBtn.disabled = true;
            loginFaceBtn.textContent = 'Memverifikasi...';

            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                           .withFaceLandmarks()
                                           .withFaceDescriptor();

            // Deteksi wajah                                           
            if (detection) {
                feedbackText.textContent = 'Wajah terdeteksi. Mengirim ke server...';
                
                const descriptorJSON = JSON.stringify(Array.from(detection.descriptor));
                
                // Sesuaikan dengan data di db
                try {
                    const response = await fetch('/login_face', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: username,
                            descriptor: descriptorJSON
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        feedbackText.textContent = 'Login berhasil! Mengalihkan...';
                        window.location.href = "{{ url_for('chat.chat_room') }}";
                    } else {
                        feedbackText.textContent = `Login Gagal: ${result.message}`;
                        loginFaceBtn.disabled = false;
                        loginFaceBtn.textContent = 'Login dengan Wajah';
                    }
                } catch (err) {
                    feedbackText.textContent = 'Error: Gagal menghubungi server.';
                    loginFaceBtn.disabled = false;
                    loginFaceBtn.textContent = 'Login dengan Wajah';
                }
                
            } else {
                feedbackText.textContent = 'Wajah tidak terdeteksi. Coba lagi.';
                loginFaceBtn.disabled = false;
                loginFaceBtn.textContent = 'Login dengan Wajah';
            }
        }
        
        startCameraBtn.addEventListener('click', startCamera);
        loginFaceBtn.addEventListener('click', handleFaceLogin);
    });
</script>
{% endblock %}